on:
  pull_request:
  push:
  workflow_dispatch:

jobs:
  compute_traceparent:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout actions
        uses: actions/checkout@v4
      - name: test traceparent script at top level
        run: |
            echo $(rapids-get-telemetry-traceparent)
      - name: Get job traceparent
        uses: ./telemetry-traceparent
        id: job-traceparent
      - name: Echo value from job
        run: echo "${{steps.job-traceparent.outputs.traceparent}}"
  example_matrix:
    name: Test ${{ matrix.os}}-${{ matrix.version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: [1, 2]
        os: [ubuntu-latest] # , windows-latest
    steps:
      - name: Checkout actions
        uses: actions/checkout@v4

      # Run job with traceparent. We'll validate that this matches in the summary data.
      - name: Get job traceparent in matrix job
        uses: ./telemetry-traceparent
        id: job-traceparent
      - name: Generate traceparent for a step
        uses: ./telemetry-traceparent
        id: step-traceparent
        with:
            step_name: "Download gha-tools with git clone"
      - name: Echo computed step traceparent
        run: |
            echo "GHA tools clone job traceparent: ${{ steps.step-traceparent.outputs.traceparent }}"
      - name: Write certificate files for mTLS
        run: |
          mkdir -p /tmp/certs
          cat << EOF > ${OTEL_EXPORTER_OTLP_CERTIFICATE}
          ${{ secrets.OTEL_EXPORTER_OTLP_CA_CERTIFICATE }}
          EOF
          cat << EOF > ${OTEL_EXPORTER_OTLP_CLIENT_CERTIFICATE}
          ${{ secrets.OTEL_EXPORTER_OTLP_CLIENT_CERTIFICATE }}
          EOF
          cat << EOF > ${OTEL_EXPORTER_OTLP_CLIENT_KEY}
          ${{ secrets.OTEL_EXPORTER_OTLP_CLIENT_KEY }}
          EOF
      - name: Test OTel export of job JSON
        uses: ./telemetry-summarize
        with:
            traceparent: ${{ steps.job-traceparent.outputs.traceparent}}
